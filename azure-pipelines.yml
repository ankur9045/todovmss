trigger : none
pool: vmss_agent
stages:
#   - stage: initandfmt
#     displayName: init and validate
#     jobs:
#       - job: initandvalidate
#         displayName: initjob
#         steps:
#         - task: TerraformInstaller@1
#           inputs:
#             terraformVersion: 'latest'
#         - task: TerraformTask@5
#           displayName: terraform init
#           inputs:
#             provider: 'azurerm'
#             command: 'init'
#             workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
#             backendServiceArm: 'Azure subscription 1(f47d98c3-f2af-4f15-988e-80b41b9098b8)'
#             backendAzureRmStorageAccountName: 'mysg'
#             backendAzureRmContainerName: 'mycon'
#             backendAzureRmKey: 'terraform.state'
#         - task: TerraformTask@5
#           displayName: terraform validate
#           inputs:
#             provider: 'azurerm'
#             command: 'validate'
#             workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
#   - stage: tfsec
#     dependsOn: initandfmt
#     displayName: tfsec&tflint
#     jobs:
#       - job: scanningtool
#         displayName: scanning tool
#         steps:
#         - task: PowerShell@2
#           displayName: tfsec
#           inputs:
#             targetType: 'inline'
#             script: 'tfsec'
#         - task: PowerShell@2
#           displayName: tflint
#           continueOnError: true
#           inputs:
#             targetType: 'inline'
#             workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
#             script: |
#               Write-Host "Current dir:"
#               pwd

#               Write-Host "Files:"
#               ls

#               Write-Host "Running tflint:"
#               tflint -force

  - stage: infracost
    jobs:
      - job: infracost
        displayName: infracost before apply
        steps:
        - task: TerraformTask@5
          displayName: terraform init
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            backendServiceArm: 'Azure subscription 1(f47d98c3-f2af-4f15-988e-80b41b9098b8)'
            backendAzureRmStorageAccountName: 'mysg'
            backendAzureRmContainerName: 'mycon'
            backendAzureRmKey: 'terraform.state'
        - task: PowerShell@2
          displayName: infracost
          inputs:
            targetType: inline
            workingDirectory: '$(System.DefaultWorkingDirectory)/dev'
            script: |
              $env:INFRACOST_API_KEY = "$(INFRACOST_API_KEY)"  # ensure variable is passed
              terraform plan -out=tfplan
              terraform show -json tfplan > plan.json
              infracost breakdown --path plan.json
              